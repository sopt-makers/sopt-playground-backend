name: Deploy JAR Lambda to Dev

on:
  workflow_dispatch:
    inputs:
      enable_snapstart:
        description: 'Enable SnapStart for Lambda'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  deploy:
    name: Build and Deploy JAR Lambda
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: Setup Gradle cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_TEMP }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_TEMP }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get application-lambda-dev.yml from AWS S3
        run: |
          aws s3 cp \
            --region ap-northeast-2 \
            s3://sopt-makers-internal/dev/deploy/application-lambda-dev.yml src/main/resources/application-lambda-dev.yml

      - name: Get Apple key from AWS S3
        run: |
          aws s3 cp \
            --region ap-northeast-2 \
            s3://sopt-makers-internal/dev/deploy/${{ secrets.APPLE_KEY }} src/main/resources/static/${{ secrets.APPLE_KEY }}

      - name: Build Lambda JAR
        run: |
          echo "Building Lambda JAR..."
          ./gradlew clean lambdaJar -x test

          echo "Build completed. Checking output:"
          ls -lah build/libs/

          # JAR 파일 이름 확인
          JAR_FILE=$(ls build/libs/*-lambda.jar | head -1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV
          echo "Built JAR: $JAR_FILE"

      - name: Generate timestamp for versioning
        id: timestamp
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "VERSION=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Generated version: $TIMESTAMP"

      - name: Upload JAR to S3
        run: |
          S3_BUCKET="sopt-makers-internal"
          S3_KEY="lambda/playground-dev/playground-${{ steps.timestamp.outputs.VERSION }}-lambda.jar"

          echo "Uploading JAR to S3..."
          aws s3 cp ${{ env.JAR_FILE }} s3://$S3_BUCKET/$S3_KEY

          echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV

          # Also upload as latest for easy reference
          aws s3 cp ${{ env.JAR_FILE }} s3://$S3_BUCKET/lambda/playground-dev/playground-latest-lambda.jar

          echo "JAR uploaded to: s3://$S3_BUCKET/$S3_KEY"

      - name: Set up Python for SAM CLI
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install AWS SAM CLI
        run: |
          pip install aws-sam-cli

      - name: Deploy Lambda with SAM
        working-directory: ./lambda
        run: |
          # Deploy using the JAR from S3
          sam deploy \
            --template-file template-dev-jar.yaml \
            --stack-name playground-dev-jar \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              S3Bucket=${{ env.S3_BUCKET }} \
              S3Key=${{ env.S3_KEY }} \
            --region ${{ secrets.AWS_REGION }}

      - name: Update Lambda function code (ensure latest)
        run: |
          # Update the function code to ensure it's using the latest JAR
          aws lambda update-function-code \
            --function-name playground-api-dev-jar \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --s3-key ${{ env.S3_KEY }} \
            --region ${{ secrets.AWS_REGION }}

          echo "Waiting for function to be updated..."
          aws lambda wait function-updated \
            --function-name playground-api-dev-jar \
            --region ${{ secrets.AWS_REGION }}

      - name: Enable SnapStart if requested
        if: inputs.enable_snapstart == 'true'
        run: |
          # Publish a new version with SnapStart
          VERSION=$(aws lambda publish-version \
            --function-name playground-api-dev-jar \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Version' \
            --output text)

          echo "Published Lambda version: $VERSION with SnapStart"

          # Update alias to point to new version
          aws lambda update-alias \
            --function-name playground-api-dev-jar \
            --name live \
            --function-version $VERSION \
            --region ${{ secrets.AWS_REGION }} || \
          aws lambda create-alias \
            --function-name playground-api-dev-jar \
            --name live \
            --function-version $VERSION \
            --region ${{ secrets.AWS_REGION }}

          echo "SnapStart enabled for version $VERSION"

      - name: Test Lambda endpoint
        run: |
          # Get API Gateway endpoint
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name playground-dev-jar \
            --query "Stacks[0].Outputs[?OutputKey=='ApiEndpoint'].OutputValue" \
            --output text \
            --region ${{ secrets.AWS_REGION }})

          echo "Testing API endpoint: $API_ENDPOINT/actuator/health"

          # Test health endpoint (with retry logic for cold start)
          for i in {1..3}; do
            if curl -f -X GET "$API_ENDPOINT/actuator/health"; then
              echo "Health check successful!"
              break
            else
              echo "Health check attempt $i failed, retrying in 10 seconds..."
              sleep 10
            fi
          done

      - name: Output deployment info
        run: |
          echo "========================================="
          echo "Deployment completed successfully!"
          echo "========================================="
          echo "JAR Location: s3://${{ env.S3_BUCKET }}/${{ env.S3_KEY }}"
          echo "Function Name: playground-api-dev-jar"
          echo "SnapStart Enabled: ${{ inputs.enable_snapstart }}"

          # Get function URL
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name playground-dev-jar \
            --query "Stacks[0].Outputs[?OutputKey=='ApiEndpoint'].OutputValue" \
            --output text \
            --region ${{ secrets.AWS_REGION }})

          echo "API Endpoint: $API_ENDPOINT"
          echo "========================================="